<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuração - Sistema de Monitoramento Solar</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-testing { background-color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-cogs text-4xl"></i>
                    <div>
                        <h1 class="text-3xl font-bold">Configuração do Sistema</h1>
                        <p class="text-blue-200">Configure os equipamentos de monitoramento solar</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        <i class="fas fa-home mr-2"></i>Dashboard
                    </a>
                    <div class="flex items-center space-x-2">
                        <div id="system-status" class="w-3 h-3 rounded-full status-online"></div>
                        <span class="text-sm">Sistema</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Status dos Equipamentos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Status do Inversor -->
            <div class="bg-white rounded-lg shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-microchip text-purple-500 mr-2"></i>
                        Inversor
                    </h3>
                    <div class="flex items-center space-x-2">
                        <div id="inverter-status" class="w-3 h-3 rounded-full status-offline"></div>
                        <span id="inverter-status-text" class="text-sm font-medium">Desconectado</span>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="text-gray-600"><strong>Modelo:</strong> String Single Inverter</p>
                    <p class="text-gray-600"><strong>SN:</strong> 2106027230</p>
                    <p class="text-gray-600"><strong>Potência:</strong> 3kW</p>
                </div>
            </div>

            <!-- Status do Logger -->
            <div class="bg-white rounded-lg shadow-lg p-6 card-hover">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">
                        <i class="fas fa-wifi text-blue-500 mr-2"></i>
                        Logger
                    </h3>
                    <div class="flex items-center space-x-2">
                        <div id="logger-status" class="w-3 h-3 rounded-full status-offline"></div>
                        <span id="logger-status-text" class="text-sm font-medium">Desconectado</span>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="text-gray-600"><strong>Modelo:</strong> LSW3_15_FFFF</p>
                    <p class="text-gray-600"><strong>SN:</strong> 1782433145</p>
                    <p class="text-gray-600"><strong>Firmware:</strong> 1.0.9E</p>
                </div>
            </div>
        </div>

        <!-- Formulário de Configuração -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">
                <i class="fas fa-network-wired text-green-500 mr-2"></i>
                Configuração de Rede
            </h2>

            <form id="config-form" class="space-y-6">
                <!-- Configurações do Inversor -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-microchip text-purple-500 mr-2"></i>
                        Configurações do Inversor
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Endereço IP
                            </label>
                            <input type="text" id="inverter-host" name="inverter_host" 
                                   value="192.168.1.100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="192.168.1.100">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Porta Modbus
                            </label>
                            <input type="number" id="inverter-port" name="inverter_port" 
                                   value="502"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="502">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Endereço Unit ID
                            </label>
                            <input type="number" id="inverter-address" name="inverter_address" 
                                   value="1"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                   placeholder="1">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="button" onclick="testConnection('inverter')" 
                                class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md transition-colors">
                            <i class="fas fa-plug mr-2"></i>Testar Conexão
                        </button>
                    </div>
                </div>

                <!-- Configurações do Logger -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-wifi text-blue-500 mr-2"></i>
                        Configurações do Logger
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Endereço IP
                            </label>
                            <input type="text" id="logger-host" name="logger_host" 
                                   value="192.168.1.101"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="192.168.1.101">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Porta Modbus
                            </label>
                            <input type="number" id="logger-port" name="logger_port" 
                                   value="502"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="502">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Endereço Unit ID
                            </label>
                            <input type="number" id="logger-address" name="logger_address" 
                                   value="2"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="2">
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="button" onclick="testConnection('logger')" 
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition-colors">
                            <i class="fas fa-plug mr-2"></i>Testar Conexão
                        </button>
                    </div>
                </div>

                <!-- Configurações Gerais -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cog text-green-500 mr-2"></i>
                        Configurações Gerais
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Intervalo de Coleta (segundos)
                            </label>
                            <input type="number" id="collection-interval" name="collection_interval" 
                                   value="60"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                   placeholder="60">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Timeout de Conexão (segundos)
                            </label>
                            <input type="number" id="connection-timeout" name="connection_timeout" 
                                   value="5"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                   placeholder="5">
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex flex-col sm:flex-row gap-4 pt-6">
                    <button type="submit" 
                            class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-md font-semibold transition-colors flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i>Salvar Configurações
                    </button>
                    
                    <button type="button" onclick="loadCurrentConfig()" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-md font-semibold transition-colors flex items-center justify-center">
                        <i class="fas fa-sync mr-2"></i>Carregar Configurações Atuais
                    </button>
                    
                    <button type="button" onclick="testAllConnections()" 
                            class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-md font-semibold transition-colors flex items-center justify-center">
                        <i class="fas fa-network-wired mr-2"></i>Testar Todas as Conexões
                    </button>
                </div>
            </form>
        </div>

        <!-- Resultados dos Testes -->
        <div id="test-results" class="mt-8 hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-clipboard-check text-blue-500 mr-2"></i>
                    Resultados dos Testes
                </h3>
                <div id="test-results-content" class="space-y-4">
                    <!-- Resultados serão inseridos aqui -->
                </div>
            </div>
        </div>

        <!-- Logs do Sistema -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center justify-between">
                <span><i class="fas fa-terminal text-gray-500 mr-2"></i>Logs do Sistema</span>
                <button onclick="refreshLogs()" class="text-blue-500 hover:text-blue-700">
                    <i class="fas fa-refresh mr-1"></i>Atualizar
                </button>
            </h3>
            <div id="system-logs" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-64 overflow-y-auto">
                <div class="text-gray-500">Carregando logs...</div>
            </div>
        </div>
    </main>

    <!-- Modal de Confirmação -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Confirmar Ação</h3>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex gap-4">
                <button onclick="confirmAction()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
                    Confirmar
                </button>
                <button onclick="cancelAction()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        let pendingAction = null;

        // Carregar configurações atuais ao inicializar
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentConfig();
            refreshLogs();
            checkSystemStatus();
        });

        // Carregar configurações atuais
        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/v1/config');
                if (response.ok) {
                    const config = await response.json();
                    
                    document.getElementById('inverter-host').value = config.modbus?.inverter_host || '192.168.1.100';
                    document.getElementById('inverter-port').value = config.modbus?.inverter_port || 502;
                    document.getElementById('inverter-address').value = config.modbus?.inverter_address || 1;
                    
                    document.getElementById('logger-host').value = config.modbus?.logger_host || '192.168.1.101';
                    document.getElementById('logger-port').value = config.modbus?.logger_port || 502;
                    document.getElementById('logger-address').value = config.modbus?.logger_address || 2;
                    
                    document.getElementById('collection-interval').value = config.application?.data_collection_interval || 60;
                    document.getElementById('connection-timeout').value = config.alerts?.connection_timeout_threshold || 5;
                    
                    showNotification('Configurações carregadas com sucesso!', 'success');
                }
            } catch (error) {
                console.error('Erro ao carregar configurações:', error);
                showNotification('Erro ao carregar configurações', 'error');
            }
        }

        // Salvar configurações
        document.getElementById('config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const config = {
                inverter_host: formData.get('inverter_host'),
                inverter_port: parseInt(formData.get('inverter_port')),
                inverter_address: parseInt(formData.get('inverter_address')),
                logger_host: formData.get('logger_host'),
                logger_port: parseInt(formData.get('logger_port')),
                logger_address: parseInt(formData.get('logger_address')),
                collection_interval: parseInt(formData.get('collection_interval')),
                connection_timeout: parseInt(formData.get('connection_timeout'))
            };

            try {
                const response = await fetch('/api/v1/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    showNotification('Configurações salvas com sucesso!', 'success');
                    setTimeout(() => {
                        checkSystemStatus();
                    }, 1000);
                } else {
                    throw new Error('Erro ao salvar configurações');
                }
            } catch (error) {
                console.error('Erro ao salvar:', error);
                showNotification('Erro ao salvar configurações', 'error');
            }
        });

        // Testar conexão individual
        async function testConnection(equipment) {
            const host = document.getElementById(`${equipment}-host`).value;
            const port = parseInt(document.getElementById(`${equipment}-port`).value);
            const address = parseInt(document.getElementById(`${equipment}-address`).value);

            // Atualizar status para "testando"
            const statusElement = document.getElementById(`${equipment}-status`);
            const statusTextElement = document.getElementById(`${equipment}-status-text`);
            
            statusElement.className = 'w-3 h-3 rounded-full status-testing';
            statusTextElement.textContent = 'Testando...';

            try {
                const response = await fetch('/api/v1/test-connection', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        equipment: equipment,
                        host: host,
                        port: port,
                        address: address
                    })
                });

                const result = await response.json();

                if (result.success) {
                    statusElement.className = 'w-3 h-3 rounded-full status-online';
                    statusTextElement.textContent = 'Conectado';
                    showNotification(`${equipment.charAt(0).toUpperCase() + equipment.slice(1)} conectado com sucesso!`, 'success');
                } else {
                    statusElement.className = 'w-3 h-3 rounded-full status-offline';
                    statusTextElement.textContent = 'Erro de Conexão';
                    showNotification(`Erro ao conectar com ${equipment}: ${result.message}`, 'error');
                }
            } catch (error) {
                console.error('Erro no teste:', error);
                statusElement.className = 'w-3 h-3 rounded-full status-offline';
                statusTextElement.textContent = 'Erro';
                showNotification(`Erro ao testar ${equipment}`, 'error');
            }
        }

        // Testar todas as conexões
        async function testAllConnections() {
            showNotification('Testando todas as conexões...', 'info');
            
            await testConnection('inverter');
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testConnection('logger');
            
            showNotification('Testes de conexão concluídos!', 'info');
        }

        // Verificar status do sistema
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/v1/system/status');
                if (response.ok) {
                    const status = await response.json();
                    
                    // Atualizar status do sistema
                    const systemStatusElement = document.getElementById('system-status');
                    if (status.data_collector_running) {
                        systemStatusElement.className = 'w-3 h-3 rounded-full status-online';
                    } else {
                        systemStatusElement.className = 'w-3 h-3 rounded-full status-offline';
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
            }
        }

        // Atualizar logs
        async function refreshLogs() {
            try {
                const response = await fetch('/api/v1/system/logs');
                if (response.ok) {
                    const data = await response.json();
                    const logsContainer = document.getElementById('system-logs');
                    
                    if (data.logs && data.logs.length > 0) {
                        logsContainer.innerHTML = data.logs.map(log => 
                            `<div class="text-gray-400">${log}</div>`
                        ).join('');
                    } else {
                        logsContainer.innerHTML = '<div class="text-gray-500">Nenhum log disponível</div>';
                    }
                    
                    // Scroll para o final
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
            } catch (error) {
                console.error('Erro ao carregar logs:', error);
                document.getElementById('system-logs').innerHTML = '<div class="text-red-500">Erro ao carregar logs</div>';
            }
        }

        // Mostrar notificação
        function showNotification(message, type = 'info') {
            // Criar elemento de notificação
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500 text-white' :
                type === 'error' ? 'bg-red-500 text-white' :
                type === 'warning' ? 'bg-yellow-500 text-white' :
                'bg-blue-500 text-white'
            }`;
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${
                        type === 'success' ? 'fa-check-circle' :
                        type === 'error' ? 'fa-exclamation-circle' :
                        type === 'warning' ? 'fa-exclamation-triangle' :
                        'fa-info-circle'
                    } mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Remover após 5 segundos
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Modal de confirmação
        function showConfirmModal(message, action) {
            document.getElementById('confirm-message').textContent = message;
            pendingAction = action;
            document.getElementById('confirm-modal').classList.remove('hidden');
            document.getElementById('confirm-modal').classList.add('flex');
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
            }
            hideConfirmModal();
        }

        function cancelAction() {
            pendingAction = null;
            hideConfirmModal();
        }

        function hideConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            document.getElementById('confirm-modal').classList.remove('flex');
        }
    </script>
</body>
</html>
